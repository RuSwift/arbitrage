<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ app_name|default("Arbitrage") }} — Admin{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="/static/css/sb-admin.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
    {% block head_extra %}{% endblock %}
</head>
<body class="sb-nav-fixed">
    <!-- Top Navigation -->
    <nav class="sb-topnav navbar navbar-expand navbar-dark bg-dark">
        <a class="navbar-brand ps-3" href="/admin">{{ app_name|default("Arbitrage") }}</a>
        <button class="btn btn-link btn-sm order-1 order-lg-0 me-4 me-lg-0" id="sidebarToggle" href="#!" aria-label="Toggle sidebar">
            <i class="bi bi-list"></i>
        </button>
        <ul class="navbar-nav ms-auto me-3 me-lg-4">
            <li class="nav-item">
                <a class="nav-link" href="/bookdepth"><i class="bi bi-graph-up me-1"></i>Book Depth</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/auth/logout" title="Выход"><i class="bi bi-box-arrow-right me-1"></i>Выход</a>
            </li>
        </ul>
    </nav>
    <!-- Main Layout -->
    <div id="layoutSidenav">
        <!-- Sidebar -->
        <div id="layoutSidenav_nav">
            <nav class="sb-sidenav accordion sb-sidenav-dark" id="sidenavAccordion">
                <div class="sb-sidenav-menu">
                    <div class="nav">
                        <template v-if="side_menu && side_menu.length > 0">
                            <template v-for="menu in side_menu" :key="'header-' + menu.header">
                                <div class="sb-sidenav-menu-heading">[[ menu.header ]]</div>
                                <template v-for="item in menu.items" :key="'item-' + item.id">
                                    <a v-if="!item.sub || item.sub.length === 0"
                                       class="nav-link"
                                       :class="{ 'active': selected_menu === item.id }"
                                       :href="item.page ? '#' : item.href"
                                       @click.prevent="selectMenu(item.id)">
                                        <div class="sb-nav-link-icon">
                                            <i :class="item.icon_class"></i>
                                        </div>
                                        [[ item.label ]]
                                    </a>
                                    <template v-else>
                                        <a class="nav-link collapsed"
                                           :class="{ 'active': selected_menu === item.id }"
                                           href="#"
                                           data-bs-toggle="collapse"
                                           :data-bs-target="'#collapse-' + item.id"
                                           @click.prevent="toggleSub(item.id)">
                                            <div class="sb-nav-link-icon"><i :class="item.icon_class"></i></div>
                                            [[ item.label ]]
                                            <div class="sb-sidenav-collapse-arrow"><i class="bi bi-chevron-down"></i></div>
                                        </a>
                                        <div class="collapse" :id="'collapse-' + item.id" data-bs-parent="#sidenavAccordion">
                                            <nav class="sb-sidenav-menu-nested nav">
                                                <a v-for="sub in item.sub" :key="'sub-' + sub.id"
                                                   class="nav-link"
                                                   :class="{ 'active': selected_menu === sub.id }"
                                                   :href="sub.page ? '#' : sub.href"
                                                   @click.prevent="selectMenu(sub.id)">[[ sub.label ]]</a>
                                            </nav>
                                        </div>
                                    </template>
                                </template>
                            </template>
                        </template>
                    </div>
                </div>
                <div class="sb-sidenav-footer">
                    <div class="small">Arbitrage Admin</div>
                </div>
            </nav>
        </div>
        <!-- Content -->
        <div id="layoutSidenav_content">
            <main>
                <div class="container-fluid px-4 py-4">
                    <ol class="breadcrumb mb-3" v-if="breadcrumb && breadcrumb.length > 0">
                        <li class="breadcrumb-item" v-for="(b, index) in breadcrumb" :key="'bc-' + index">
                            <span v-if="index === breadcrumb.length - 1" class="text-primary">[[ b ]]</span>
                            <span v-else>[[ b ]]</span>
                        </li>
                    </ol>
                    <div class="mb-4">
                        <component :is="current_page || 'Crawler'"></component>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.16/dist/vue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/bookdepth.js"></script>
    <script src="/static/js/klines.js"></script>
    <script src="/static/js/admin.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (typeof Vue === 'undefined') return;
            if (window.panelApp) return;
            window.panelApp = new Vue({
                el: '#layoutSidenav',
                delimiters: ['[[', ']]'],
                data: {
                    selected_menu: '{{ selected_menu|default("crawler") }}',
                    current_page: '{{ current_page|default("Crawler") }}',
                    side_menu: {{ side_menu|default([])|tojson }}
                },
                computed: {
                    breadcrumb: function () {
                        var stack = [];
                        var menu = this.side_menu || [];
                        for (var i = 0; i < menu.length; i++) {
                            var group = menu[i];
                            for (var j = 0; j < (group.items || []).length; j++) {
                                var item = group.items[j];
                                stack.push(item.label);
                                if (this.selected_menu === item.id) return stack;
                                if (item.sub && item.sub.length > 0) {
                                    for (var n = 0; n < item.sub.length; n++) {
                                        stack.push(item.sub[n].label);
                                        if (this.selected_menu === item.sub[n].id) return stack;
                                        stack.pop();
                                    }
                                }
                                stack.pop();
                            }
                        }
                        return stack;
                    }
                },
                methods: {
                    selectMenu: function (id) {
                        var item = this.getMenu(id);
                        if (!item) return;
                        if (item.page) {
                            this.selected_menu = id;
                            this.current_page = item.page;
                        } else if (item.href) {
                            window.location.href = item.href;
                        }
                    },
                    toggleSub: function (id) {
                        var item = this.getMenu(id);
                        if (item && item.page) {
                            this.selected_menu = id;
                            this.current_page = item.page;
                        }
                    },
                    getMenu: function (id) {
                        var menu = this.side_menu || [];
                        for (var i = 0; i < menu.length; i++) {
                            for (var j = 0; j < (menu[i].items || []).length; j++) {
                                var item = menu[i].items[j];
                                if (item.id === id) return item;
                                if (item.sub) {
                                    for (var n = 0; n < item.sub.length; n++) {
                                        if (item.sub[n].id === id) return item.sub[n];
                                    }
                                }
                            }
                        }
                        return null;
                    }
                }
            });
            var toggle = document.getElementById('sidebarToggle');
            if (toggle) {
                toggle.addEventListener('click', function (e) {
                    e.preventDefault();
                    document.body.classList.toggle('sb-sidenav-toggled');
                });
            }
        });
    </script>
    {% block scripts_extra %}{% endblock %}
</body>
</html>
