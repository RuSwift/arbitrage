<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Depth — Arbitrage</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        .order-book-binance { background: #1e2329; border-radius: 0.5rem; overflow: hidden; color: #eaecef; }
        .order-book-header { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0.75rem; border-bottom: 1px solid #2b3139; font-size: 0.8rem; }
        .order-book-title { color: #848e9c; }
        .order-book-symbol { color: #eaecef; font-weight: 500; }
        .order-book-columns { display: flex; flex-wrap: wrap; align-items: stretch; }
        .order-book-col { flex: 1; min-width: 200px; }
        .order-book-divider { flex-shrink: 0; width: 4.5rem; min-width: 4.5rem; background: #1e2329; border-left: 1px solid #2b3139; border-right: 1px solid #2b3139; }
        .order-book-divider-table { width: 100%; }
        .order-book-divider-table th { padding: 0.35rem 0.4rem; color: #848e9c; font-weight: 500; text-align: center; }
        .order-book-divider-table td.order-book-pct-cell { padding: 0.2rem 0.4rem; font-size: 0.7rem; color: #848e9c; text-align: center; white-space: nowrap; }
        .order-book-table { width: 100%; font-size: 0.75rem; border-collapse: collapse; }
        .order-book-table th { padding: 0.35rem 0.5rem; color: #848e9c; font-weight: 500; text-align: right; }
        .order-book-table th:first-child { text-align: left; }
        .order-book-table td { padding: 0.2rem 0.5rem; position: relative; text-align: right; }
        .order-book-table td:first-child { text-align: left; }
        .order-book-combo-th { min-width: 10rem; }
        .order-book-combo-th .ob-price-label { float: left; }
        .order-book-combo-th .ob-usd-label { float: right; }
        .order-book-combo-cell { position: relative; min-width: 10rem; padding: 0.2rem 0.5rem; }
        .order-book-combo-cell .depth-bar { position: absolute; top: 0; bottom: 0; z-index: 0; border-radius: 0; }
        .order-book-combo-cell .ob-price { position: relative; z-index: 1; float: left; }
        .order-book-combo-cell .ob-usd { position: relative; z-index: 1; float: right; }
        .order-book-combo-cell.bid-price { color: #0ecb81; }
        .order-book-combo-cell.bid-price .depth-bar { right: 0; background: rgba(14, 203, 129, 0.2); max-width: 100%; }
        .order-book-combo-cell.ask-price { color: #f6465d; }
        .order-book-combo-cell.ask-price .depth-bar { right: auto; left: 0; background: rgba(246, 70, 93, 0.2); max-width: 100%; }
        .order-book-asks .order-book-combo-th .ob-usd-label { float: left; }
        .order-book-asks .order-book-combo-th .ob-price-label { float: right; }
        .order-book-asks .order-book-combo-cell .ob-usd { float: left; }
        .order-book-asks .order-book-combo-cell .ob-price { float: right; }
    </style>
</head>
<body class="bg-light">
    <header class="border-bottom bg-white mb-3">
        <nav class="container-fluid py-2 d-flex align-items-center gap-3">
            <a href="/admin" class="text-decoration-none text-secondary">Crawler Admin</a>
            <a href="/bookdepth" class="text-decoration-none fw-semibold text-dark">Book Depth</a>
        </nav>
    </header>
    <div id="bookdepth-app" class="container-fluid py-4">
        <div class="card">
            <div class="card-body">
                <div class="row g-2 mb-3 align-items-end">
                    <div class="col-auto">
                        <label class="form-label mb-0 small">ID итерации</label>
                        <input type="number" class="form-control form-control-sm" style="width: 120px" v-model="iterationId" placeholder="например 1" @keyup.enter="load">
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-sm btn-primary" @click="load" :disabled="loading">Загрузить</button>
                    </div>
                    <div class="col-auto text-muted small" v-if="error">[[ error ]]</div>
                </div>
                <div v-if="loading" class="text-center py-4"><div class="spinner-border text-primary"></div></div>
                <book-depth v-else-if="iteration" :book-depth="iteration.book_depth" :token="iteration.token"></book-depth>
                <p v-else-if="!iteration && !loading" class="text-muted mb-0">Введите ID итерации и нажмите «Загрузить» (данные из Crawler).</p>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.16/dist/vue.min.js"></script>
    <script src="/static/js/bookdepth.js"></script>
    <script>
        new Vue({
            el: '#bookdepth-app',
            delimiters: ['[[', ']]'],
            data: {
                iterationId: '',
                iteration: null,
                loading: false,
                error: null
            },
            methods: {
                load: function () {
                    var id = (this.iterationId || '').trim();
                    if (!id) {
                        this.error = 'Введите ID итерации';
                        return;
                    }
                    this.loading = true;
                    this.error = null;
                    this.iteration = null;
                    var self = this;
                    fetch('/api/admin/crawler/iterations/' + id)
                        .then(function (r) {
                            if (!r.ok) throw new Error('Итерация не найдена');
                            return r.json();
                        })
                        .then(function (data) {
                            self.iteration = data;
                        })
                        .catch(function (e) {
                            self.error = e.message || 'Ошибка загрузки';
                        })
                        .finally(function () {
                            self.loading = false;
                        });
                }
            }
        });
    </script>
</body>
</html>
